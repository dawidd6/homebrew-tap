name: Uploading

on:
  workflow_dispatch:
    inputs:
      pr:
        description: Pull request number
        required: true

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew
        run: brew update-reset $(brew --repo)
      - name: Checkout tap
        uses: actions/checkout@v2
        with:
          token: ${{secrets.HOMEBREW_GITHUB_API_TOKEN}}
          fetch-depth: 0
      - name: Setup tap
        run: |
          mkdir -p $(dirname $(brew --repo $GITHUB_REPOSITORY))
          ln -s $PWD $(brew --repo $GITHUB_REPOSITORY)
      - name: Setup git
        uses: Homebrew/actions/git-user-config@master
      - name: Pull bottles
        env:
          HOMEBREW_BINTRAY_USER: ${{secrets.HOMEBREW_BINTRAY_USER}}
          HOMEBREW_BINTRAY_KEY: ${{secrets.HOMEBREW_BINTRAY_KEY}}
          HOMEBREW_GITHUB_API_TOKEN: ${{secrets.HOMEBREW_GITHUB_API_TOKEN}}
          PR: ${{github.event.inputs.pr}}
        run: |
          brew pr-pull \
            --bintray-org=$HOMEBREW_BINTRAY_USER \
            --tap=$GITHUB_REPOSITORY \
            --workflow=building.yml \
            --artifact=bottles \
            $PR
      - name: Push commits
        uses: Homebrew/actions/git-try-push@master
      - name: Delete branch
        uses: peter-evans/close-pull@v1
        with:
          token: ${{secrets.HOMEBREW_GITHUB_API_TOKEN}}
          pull-request-number: ${{github.event.inputs.pr}}
          delete-branch: true
