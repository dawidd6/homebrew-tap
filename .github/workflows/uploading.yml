name: Uploading

on:
  workflow_dispatch:
    inputs:
      pull_request:
        description: Pull request number
        required: true

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Setup git
        uses: Homebrew/actions/git-user-config@master
      - name: Pull bottles
        env:
          HOMEBREW_BINTRAY_USER: ${{secrets.HOMEBREW_BINTRAY_USER}}
          HOMEBREW_BINTRAY_KEY: ${{secrets.HOMEBREW_BINTRAY_KEY}}
          HOMEBREW_GITHUB_API_TOKEN: ${{secrets.HOMEBREW_GITHUB_API_TOKEN}}
          PR: ${{github.event.inputs.pull_request}}
        run: >
          brew pr-pull
            --bintray-org=$HOMEBREW_BINTRAY_USER
            --tap=$GITHUB_REPOSITORY
            --workflow=building.yml
            --artifact=bottles
            $PR
      - name: Push commits
        uses: Homebrew/actions/git-try-push@master
        with:
          token: ${{secrets.HOMEBREW_GITHUB_API_TOKEN}}
      - name: Delete branch
        uses: peter-evans/close-pull@v1
        with:
          token: ${{secrets.HOMEBREW_GITHUB_API_TOKEN}}
          pull-request-number: ${{github.event.inputs.pull_request}}
          delete-branch: true
