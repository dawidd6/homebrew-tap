name: Uploading

on:
  push:
    branches:
      - master
    paths:
      - 'Formula/*'

jobs:
  upload:
    runs-on: ubuntu-latest
    container:
      image: homebrew/brew
    steps:
      - name: Update Homebrew
        run: |
          brew update-reset $(brew --repo)
      - name: Hack brew
        run: |
          cd $(brew --repo)
          git fetch https://github.com/dawidd6/brew bintray-data:bintray-data
          git checkout bintray-data
      - name: Checkout tap
        uses: actions/checkout@v2
      - name: Setup tap
        run: |
          mkdir -p $(dirname $(brew --repo $GITHUB_REPOSITORY))
          ln -s $PWD $(brew --repo $GITHUB_REPOSITORY)
      - name: Setup git
        run: |
          git config --global user.name "${{github.event.pusher.name}}"
          git config --global user.email "${{github.event.pusher.email}}"
      - name: Find PR
        uses: jwalton/gh-find-current-pr@v1
        id: pr
        with:
          github-token: ${{github.token}}
      - name: Pull bottles
        env:
          HOMEBREW_BINTRAY_REPO: bottles-tap
          HOMEBREW_BINTRAY_USER: dawidd6
          HOMEBREW_BINTRAY_KEY: ${{secrets.HOMEBREW_BINTRAY_KEY}}
          NUMBER: ${{steps.pr.outputs.number}}
          DATA: '{"licenses":["MIT"],"vcs_url":"${{github.repository}}"}'
          ARTIFACT: bottles
          WORKFLOW: building.yml
        run: |
          brew pr-pull \
            --bintray-extra-data-args=$DATA
            --bintray-org=$HOMEBREW_BINTRAY_USER \
            --tap=$GITHUB_REPOSITORY \
            --artifact=$ARTIFACT \
            --workflow=$WORKFLOW \
            $NUMBER
      - name: Push commits
        run: |
          for try in $(seq 10); do
            git pull --rebase
            if git push; then
              exit 0
            fi
            sleep $(shuf -i 3-10 -n 1)
          done
          exit 1
